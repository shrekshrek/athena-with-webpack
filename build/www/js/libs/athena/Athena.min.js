/*!
 * VERSION: 1.2.0
 * DATE: 2015-05-29
 * GIT:https://github.com/shrekshrek/athena-for-mobile
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;define(["bone","jquery","exports"],function(n,i,a){e.Athena=t(e,a,n,i)})}(function(t,e,n,i){function a(t,e){if(void 0===t.length)e.call(t,0,t);else for(var n=0;n<t.length;n++)e.call(t[n],n,t[n])}function s(t){V=t||i("body"),z=i("body"),W=i(window),F=i(document),U=!1,H=e.NORMAL,J={},K={},Q=[],W.resize(function(){x()}),x()}function o(t){if(!V)throw"athena havn't stage, must be init!!!";var e=c(t);d("on",e)||(Q.push({action:"on",data:e}),G||l())}function r(t){o(t)}function h(t){if(!V)throw"athena havn't stage, must be init!!!";var e=c(t);d("off",e)||(Q.push({action:"off",data:e}),G||l())}function l(){if(Q.length){var t=Q.shift();switch(Y=t.data,G=!0,t.action){case"on":te=0,ee=0,ne={},a(Y,function(t,e){p(e)}),e.trigger(e.FLOW_START,{data:Y});break;case"off":a(Y,function(t,n){var i=J[n.depth];e.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){R(n)}),i.transitionOut()})}}else Y=null,G=!1}function d(t,e){var n=!1;if(Q.length){var i=Q[Q.length-1];a(e,function(e,a){i.action==t&&i.data==a&&(n=!0)})}return n}function c(t){if(!t)throw"page data is undefined!";var e=[];return a(t,function(t,n){"number"==typeof n?n=J[n]:"string"==typeof n&&(n=J[f(n)]);var i=n.data||n;if(!i.view)throw"page data has wrong!!! must has 'data.view'";if(!i.depth)throw"page data has wrong!!! must has 'data.depth'";i.depth=f(i.depth),e.push(i)}),e}function u(t){return f(t)}function f(t){var n=B[2];switch(typeof t){case"string":t=t.toLowerCase();var i="",a=0,s=Math.max(t.indexOf("+"),t.indexOf("-"));switch(s>0?(n=t.substring(0,s),i=t.substring(s,s+1),a=parseInt(t.substring(s+1))):n=t,n){case e.PRELOAD:n=B[0];break;case e.TOP:n=B[1];break;case e.MIDDLE:n=B[2];break;case e.BOTTOM:n=B[3]}switch(i){case"+":n+=a;break;case"-":n-=a}break;case"number":n=Math.floor(t)}return n}function O(t){I(),require([t.view],function(n){var i=new n(t.data?t:{data:t});K[t.depth]=i,V.append(i.el),i.init(),w(t),e.listenToOnce(i,e.PRELOAD_COMPLETE,function(){T(t)}),i.preload(U||"true"===t.fast)})}function p(t){var n=t,i=J[n.depth],a=n.flow||H;switch(a){case e.NORMAL:i?(e.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){g(n)}),i.transitionOut()):g(n);break;case e.PRELOAD:case e.REVERSE:case e.CROSS:O(n)}}function g(t){var n=t,i=J[n.depth],a=K[n.depth],s=n.flow||H;switch(s){case e.NORMAL:O(n);break;case e.PRELOAD:i?(e.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){E(n)}),i.transitionOut()):E(n);break;case e.REVERSE:e.listenToOnce(a,e.TRANSITION_IN_COMPLETE,function(){E(n)}),a.transitionIn();break;case e.CROSS:i&&i.transitionOut(),E(n)}}function E(t){var n=t,i=J[n.depth],a=K[n.depth],s=n.flow||H;switch(s){case e.NORMAL:case e.PRELOAD:case e.CROSS:e.listenToOnce(a,e.TRANSITION_IN_COMPLETE,function(){R(n)}),a.transitionIn();break;case e.REVERSE:i?(e.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){R(n)}),i.transitionOut()):R(n)}}function R(t){var n=t,i=J[n.depth],a=K[n.depth];i&&delete J[n.depth],a&&(J[n.depth]=a,delete K[n.depth]),n.routing&&(document.title=n.routing),te++,te>=Y.length&&(e.trigger(e.FLOW_COMPLETE,{data:Y}),l())}function T(t){var n=t,i=n.flow||H;te++,te>=Y.length&&(te=0,a(Y,function(t,n){switch(i){case e.NORMAL:E(n);break;case e.PRELOAD:case e.REVERSE:case e.CROSS:g(n)}}))}function _(t){if(t){if(!V)throw"athena havn't stage!!!";X&&(X.destroy(),X=null);var n=t.data||t;if(n.depth=f(e.PRELOAD),!n.view)throw"preloader must have data.view!!!";return require([n.view],function(i){X=new i(t.data?t:{data:n}),V.append(X.el),X.init(),e.trigger(e.PRELOAD_PREPARE)}),X}return X}function w(t){if(X){var n=t,i=K[n.depth];e.listenTo(i,e.PRELOAD_PROGRESS,P),e.listenTo(i,e.PRELOAD_COMPLETE,A)}}function L(t){if(X){var n=t,i=K[n.depth];e.stopListening(i,e.PRELOAD_PROGRESS,P),e.stopListening(i,e.PRELOAD_COMPLETE,A)}}function I(){X&&(ee++,ee>=Y.length&&(ee=0,X.transitionIn()))}function P(t){if(X){ne[t.data.depth]=t.progress;var e=0;for(var n in ne)e+=ne[n]/Y.length;X.progress({progress:e})}}function A(t){X&&(L(t.data),ee++,ee>=Y.length&&(ee=0,X.transitionOut()))}function S(t){var e=null;for(var n in K)K[n].data===t&&(e=K[n]);if(!e)for(var n in J)J[n].data===t&&(e=J[n]);return e}function v(t){var e=t?f(t):B[2],n=K[e]||J[e];return n}function N(t){if(t){if("boolean"!=typeof t)throw"setFullScreen params must be bool!!!";j=t,x()}return j}function m(t){if(t){if("boolean"!=typeof t)throw"preloadFast params must be bool!!!";U=t}return U}function C(){return G}function b(){return Z}function M(t){return t&&($.width=t.width||$.width,$.height=t.height||$.height,V.css({"min-width":$.width,"min-height":$.height})),$}function D(){return q}function y(t){if(t)switch(t=t.toLowerCase()){case e.NORMAL:case e.PRELOAD:case e.REVERSE:case e.CROSS:_flow=t}return _flow}function x(){Z.width=W.width(),Z.height=W.height(),j&&V.css({width:Z.width,height:Z.height}),q.width=V.width(),q.height=V.height(),e.trigger(e.WINDOW_RESIZE)}var k=t.Athena;e.VERSION="1.2.0",e.noConflict=function(){return t.Athena=k,this},n.extend(e,n.Events,{PRELOAD_START:"preloadStart",PRELOAD_PROGRESS:"preloadProgress",PRELOAD_COMPLETE:"preloadComplete",TRANSITION_IN:"transitionIn",TRANSITION_IN_COMPLETE:"transitionInComplete",TRANSITION_OUT:"transitionOut",TRANSITION_OUT_COMPLETE:"transitionOutComplete",PRELOAD:"preload",TOP:"top",MIDDLE:"middle",BOTTOM:"bottom",NORMAL:"normal",REVERSE:"reverse",CROSS:"cross",FLOW_START:"flowStart",FLOW_COMPLETE:"flowComplete",WINDOW_RESIZE:"windowResize",PRELOAD_PREPARE:"preloadPrepare"});var z=null,V=null,W=null,F=null,U=!1,H=null,G=!1,j=!1,q={width:0,height:0},Z={width:0,height:0},$={width:1,height:1},B=[1500,1e3,500,0],J={},K={},Q=[],X=null,Y=null,te=null,ee=null,ne=null;return n.extend(e,{init:s,pageTo:r,pageOn:o,pageOff:h,calcDepth:u,preloader:_,getPage:S,getPageAt:v,fullScreen:N,preloadFast:m,isFlowing:C,windowRect:b,windowRectMin:M,stageRect:D,flow:y,resize:x}),e.View=n.View.extend({template:null,parent:null,children:null,args:null,_isInited:null,events:{},initialize:function(t){this.children=[],t&&(this.args=t,t.template&&(this.template=t.template,this.render()))},init:function(){this._isInited||(this._isInited=!0)},destroy:function(){this.parent=null,a(this.children,function(t,e){e.destroy()}),this.children=null,this.remove()},render:function(){this.template&&this.$el.html(this.template)},resize:function(){},addChild:function(t,e){a(this.children,function(t,e){}),t.parent=this,this.children.push(t),e&&(e.append(t.el),t.init())},removeChild:function(t){a(this.children,function(e,n){return n===t?(this.children.splice(e,1),void t.destroy()):void 0})}}),e.Page=e.View.extend({_loadMax:null,_loaded:null,data:null,initialize:function(t){e.Page.__super__.initialize.apply(this,[t]),this.data=t.data,this.$el.css({"z-index":this.data.depth});var n=[],s=this.data.assets&&void 0!==this.data.assets.length?this.data.assets:[];a(s,function(t,e){n.push(i(new Image).attr({src:e})[0].src)}),this.data.assets=n},init:function(t){e.Page.__super__.init.apply(this,[t]),this.listenTo(e,e.WINDOW_RESIZE,function(){this.resize()})},destroy:function(){e.Page.__super__.destroy.apply(this)},preload:function(t){if(this.trigger(e.PRELOAD_START,{data:this.data}),t)return void this.completeHandle();for(var n=this,s=this.$el.find("img"),o=this.data.assets||[],r=s.length-1;r>=0;r--)s[r].src&&""!==s[r].src&&o.push(s[r].src);this._loadMax=o.length,this._loaded=0,0===this._loadMax?(this.progressHandle(1),this.completeHandle()):a(o,function(t,e){i(new Image).load(function(){n._assetLoadComplete()}).error(function(){n._assetLoadComplete()}).attr("src",e)})},_assetLoadComplete:function(){this._loaded++,this.progressHandle(this._loaded/this._loadMax),this._loaded>=this._loadMax&&this.completeHandle()},progressHandle:function(t){this.trigger(e.PRELOAD_PROGRESS,{data:this.data,progress:t})},completeHandle:function(){this.trigger(e.PRELOAD_COMPLETE,{data:this.data})},transitionIn:function(){this.resize(),this.trigger(e.TRANSITION_IN,{data:this.data})},transitionInComplete:function(){this.trigger(e.TRANSITION_IN_COMPLETE,{data:this.data})},transitionOut:function(){this.trigger(e.TRANSITION_OUT,{data:this.data})},transitionOutComplete:function(){this.destroy(),this.trigger(e.TRANSITION_OUT_COMPLETE,{data:this.data})}}),e});
